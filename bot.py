import asyncio
import logging
import requests
import random
from aiogram import Bot
from apscheduler.schedulers.asyncio import AsyncioScheduler

# --- –¢–í–û–ò –î–ê–ù–ù–´–ï –£–ñ–ï –¢–£–¢ ---
API_TOKEN = '8309438145:AAEGBACLyLh2H_OyUk6ScDYpvNJU9_OaQyQ'
CHANNEL_ID = '@iPromt_AI'
POSTS_PER_DAY = 20
INTERVAL_SECONDS = (24 * 60 * 60) // POSTS_PER_DAY # –ü—Ä–∏–º–µ—Ä–Ω–æ –∫–∞–∂–¥—ã–µ 72 –º–∏–Ω—É—Ç—ã

logging.basicConfig(level=logging.INFO)
bot = Bot(token=API_TOKEN)
scheduler = AsyncioScheduler()

# –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –≤ –ø–∞–º—è—Ç–∏, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Å—Ç–∏—Ç—å –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ –∑–∞ –æ–¥–∏–Ω —Å–µ–∞–Ω—Å
posted_urls = set()

def get_ai_content():
    # –ò—â–µ–º –Ω–∞ Reddit –≤ —Ç–æ–ø–æ–≤—ã—Ö —Å–æ–æ–±—â–µ—Å—Ç–≤–∞—Ö –ø–æ –Ω–µ–π—Ä–æ—Å–µ—Ç—è–º
    subreddits = ['midjourney', 'StableDiffusion', 'DALL-E']
    sub = random.choice(subreddits)
    url = f"https://www.reddit.com/r/{sub}/hot.json?limit=50"
    headers = {'User-agent': 'AI-Prompt-Bot-v1'}
    
    # –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –ª—é–¥–µ–π/–ø–∞—Ä
    keywords = ['woman', 'man', 'couple', 'girl', 'boy', 'portrait', 'people', 'love', 'model', 'human']
    
    try:
        response = requests.get(url, headers=headers).json()
        posts = response['data']['children']
        random.shuffle(posts)
        
        for post in posts:
            data = post['data']
            title = data['title'].lower()
            img_url = data.get('url', '')
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞: —ç—Ç–æ –∫–∞—Ä—Ç–∏–Ω–∫–∞, –º—ã –µ–µ –µ—â–µ –Ω–µ –ø–æ—Å—Ç–∏–ª–∏ –∏ —Ç–∞–º –µ—Å—Ç—å –ª—é–¥–∏
            if img_url.endswith(('.jpg', '.png', '.jpeg')) and img_url not in posted_urls:
                if any(word in title for word in keywords):
                    posted_urls.add(img_url)
                    return img_url, data['title']
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {e}")
    return None, None

async def post_now():
    image, prompt = get_ai_content()
    if image:
        try:
            caption = f"üé® **Prompt:** {prompt}\n\nü§ñ Generated by AI\nüìç Source: Reddit\n\n#ai #prompts #art #people"
            await bot.send_photo(chat_id=CHANNEL_ID, photo=image, caption=caption, parse_mode="Markdown")
            logging.info(f"–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –≤ {CHANNEL_ID}")
        except Exception as e:
            logging.error(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram: {e}")

async def main():
    # –°—Ä–∞–∑—É –¥–µ–ª–∞–µ–º –ø–µ—Ä–≤—ã–π –ø–æ—Å—Ç –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
    await post_now()
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä –Ω–∞ 20 –ø–æ—Å—Ç–æ–≤ –≤ –¥–µ–Ω—å
    scheduler.add_job(post_now, 'interval', seconds=INTERVAL_SECONDS)
    scheduler.start()
    
    # –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ä–∞–±–æ—Ç—É —Å–∫—Ä–∏–ø—Ç–∞
    while True:
        await asyncio.sleep(3600)

if __name__ == '__main__':
    try:
        asyncio.run(main())
    except (KeyboardInterrupt, SystemExit):
        pass